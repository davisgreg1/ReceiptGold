// Firestore Security Rules for ReceiptGold

rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        // Transaction Candidates collection - users can only access their own candidates
        match /transactionCandidates/{candidateId} {
            allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
            allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
            allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        // Generated Receipts collection - users can only access their own generated receipts
        match /generatedReceipts/{receiptId} {
            allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
            allow list: if isAuthenticated();
            allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
            allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        // Candidate Status collection - users can only access their own candidate statuses
        match /candidateStatus/{statusId} {
            allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
            allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
            allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        // Bank Connections collection - users can only access their own bank connections
        match /bankConnections/{connectionId} {
            allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
            allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
            allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        // Plaid Items collection - users can only access their own plaid items
        match /plaid_items/{itemId} {
            allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
            allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
            allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        // Merchant Categories collection - shared data for categorizing merchants
        match /merchantCategories/{merchantId} {
            // Anyone authenticated can read merchant categories
            allow read: if isAuthenticated();

            // Anyone authenticated can create/update merchant categories
            // This allows crowdsourced categorization from all users
            allow create, update: if isAuthenticated() &&
            // Validate required fields
            request.resource.data.keys().hasAll(['merchantName', 'category', 'confidence']) &&
            // Validate data types
            request.resource.data.merchantName is string &&
            request.resource.data.category is string &&
            request.resource.data.confidence is number &&
            // Validate confidence is between 0 and 1
            request.resource.data.confidence >= 0 && request.resource.data.confidence <= 1;

            // Only allow deletion by admins or Cloud Functions
            allow delete: if isAdmin();
        }

        // Helper functions
        function isAuthenticated() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return isAuthenticated() && request.auth.uid == userId;
        }

        function isValidUser() {
            return isAuthenticated() && request.auth.uid != null;
        }

        function hasValidEmail() {
            return isAuthenticated() && request.auth.token.email_verified == true;
        }

        // Users collection - users can only access their own data
        match /users/{userId} {
            allow read, write: if isOwner(userId);

            // Allow creation during signup
            allow create: if isAuthenticated() && 
            request.auth.uid == userId &&
            hasValidEmail();

            // Allow users to delete their own account
            allow delete: if isOwner(userId);
        }

        // Subscriptions collection - read only for users, write only via Cloud Functions
        match /subscriptions/{userId} {
            allow read: if isOwner(userId);

            // Allow users to initialize trial from free tier
            allow update: if isOwner(userId) && 
            // Only allow converting from free to trial
            resource.data.currentTier == "free" &&
            request.resource.data.currentTier == "trial" &&
            // Ensure trial data is being added
            request.resource.data.keys().hasAll(['trial']) &&
            // Prevent users from upgrading to paid tiers
            request.resource.data.currentTier in ["free", "trial"];

            // Only Cloud Functions can write other subscription changes
            // This prevents users from upgrading themselves to paid tiers
            allow write: if false;

            // Allow creation during user initialization and trial setup
            allow create: if isOwner(userId);

            // Allow users to delete their subscription during account deletion
            allow delete: if isOwner(userId);
        }

        // Receipts collection - users can only access their own receipts
        match /receipts/{receiptId} {
            allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;

            // Simplified: Only require userId for creation
            allow create: if isAuthenticated() && 
            request.auth.uid == request.resource.data.userId &&
            // Validate userId is present and is a string
            request.resource.data.keys().hasAll(['userId']) &&
            request.resource.data.userId is string;

            allow update: if isAuthenticated() && 
            request.auth.uid == resource.data.userId &&
            // Prevent changing userId
            request.resource.data.userId == resource.data.userId;

            allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        // Businesses collection - users can only access their own businesses
        match /businesses/{businessId} {
            allow read, write: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;

            allow create: if isAuthenticated() && 
            request.auth.uid == request.resource.data.userId &&
            // Validate required fields
            request.resource.data.keys().hasAll(['userId', 'name']) &&
            // Validate business name is not empty
            request.resource.data.name.size() > 0;

            allow update: if isAuthenticated() && 
            request.auth.uid == resource.data.userId &&
            // Prevent changing userId
            request.resource.data.userId == resource.data.userId;

            allow delete: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;
        }

        // Reports collection - users can only access their own reports
        match /reports/{reportId} {
            allow read: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;

            allow create: if isAuthenticated() && 
            request.auth.uid == request.resource.data.userId &&
            // Validate required fields
            request.resource.data.keys().hasAll(['userId', 'type', 'title']);

            allow update: if isAuthenticated() && 
            request.auth.uid == resource.data.userId &&
            // Prevent changing userId
            request.resource.data.userId == resource.data.userId;

            allow delete: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;
        }

        // Usage collection - read only for users, write only via Cloud Functions
        match /usage/{usageId} {
            // Allow users to read their own usage data
            allow read: if isAuthenticated() && 
            usageId.startsWith(request.auth.uid + '_');

            // Only Cloud Functions can write usage data
            allow write: if false;

            // Allow creation during user initialization
            allow create: if isAuthenticated() && 
            usageId.startsWith(request.auth.uid + '_') &&
            request.resource.data.userId == request.auth.uid;

            // Allow users to delete their usage data during account deletion
            allow delete: if isAuthenticated() && 
            usageId.startsWith(request.auth.uid + '_');
        }

        // Categories collection - public read access, admin write only
        match /categories/{categoryId} {
            // Anyone can read categories (for autocomplete, etc.)
            allow read: if true;

            // Only admins can write categories
            // This would need to be updated with admin logic or use Cloud Functions
            allow write: if false;
        }

        // Custom Categories collection - users can only access their own custom categories
        match /customCategories/{categoryId} {
            allow read: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;

            allow create: if isAuthenticated() && 
            request.auth.uid == request.resource.data.userId &&
            // Validate required fields
            request.resource.data.keys().hasAll(['userId', 'name', 'icon']) &&
            // Validate data types
            request.resource.data.name is string &&
            request.resource.data.icon is string &&
            // Validate name length
            request.resource.data.name.size() >= 2 && 
            request.resource.data.name.size() <= 30;

            allow update: if isAuthenticated() && 
            request.auth.uid == resource.data.userId &&
            // Prevent changing userId
            request.resource.data.userId == resource.data.userId;

            allow delete: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;
        }

        // Budgets collection - users can only access their own budgets
        match /budgets/{budgetId} {
            allow read: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;

            allow create: if isAuthenticated() && 
            request.auth.uid == request.resource.data.userId &&
            // Validate required fields
            request.resource.data.keys().hasAll(['userId', 'name', 'amount']);

            allow update: if isAuthenticated() && 
            request.auth.uid == resource.data.userId &&
            // Prevent changing userId
            request.resource.data.userId == resource.data.userId;

            allow delete: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;
        }

        // Admin functions (if needed)
        // You can extend this with custom claims for admin users
        function isAdmin() {
            return isAuthenticated() && 
            request.auth.token.admin == true;
        }

        // Admin-only collections (if you add them later)
        match /admin/{document=**} {
            allow read, write: if isAdmin();
        }

        // Analytics collection (optional - for tracking app usage)
        match /analytics/{document=**} {
            // Only allow reading/writing via Cloud Functions
            allow read, write: if false;
        }

        // User notifications - users can read/write their own notifications
        match /user_notifications/{notificationId} {
            allow read, write: if isAuthenticated() && 
            (request.auth.uid == resource.data.userId || 
             request.auth.uid == request.resource.data.userId);
        }

        // Connection notifications - read-only for users, write via Cloud Functions
        match /connection_notifications/{notificationId} {
            allow read: if isAuthenticated() && 
            request.auth.uid == resource.data.userId;
            allow write: if false; // Only Cloud Functions can write
        }

        // Audit logs (optional - for compliance)
        match /audit_logs/{logId} {
            // Users can read their own audit logs
            allow read: if isAuthenticated() && 
            resource.data.userId == request.auth.uid;

            // Only Cloud Functions can write audit logs
            allow write: if false;
        }
    }
}